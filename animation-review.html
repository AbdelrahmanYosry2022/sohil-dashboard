<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>لوحة مراجعة الأنيميشن – مكتبة → مجلد → مشهد (RTL)</title>
    <!-- Tailwind CDN (for local demo; in production use a proper build) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 + ReactDOM + Babel Standalone -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useRef } = React;

      // ------------ Helpers ------------
      function cx(...args) {
        return args.filter(Boolean).join(" ");
      }

      // =================================
      //            ROOT ROUTER
      // =================================
      function AnimationWorkspace() {
        const [page, setPage] = useState("library"); // "library" | "folder" | "review"
        const [viewMode, setViewMode] = useState("grid"); // "grid" | "list"

        // ---- Mock seed data
        const [folders, setFolders] = useState([
          {
            id: "f-01",
            name: "المقدمة – الحلقة 01",
            order: 1,
            scenes: [
              {
                id: "s-01",
                title: "المشهد 01 – الافتتاح",
                thumbnail:
                  "https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=800&auto=format&fit=crop",
                status: "approved",
                shots: 8,
                comments: 0,
                lastUpdateISO: "2025-08-24T10:00:00Z",
              },
              {
                id: "s-02",
                title: "المشهد 02 – اكتشاف الكتاب",
                thumbnail:
                  "https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?q=80&w=800&auto=format&fit=crop",
                status: "review",
                shots: 12,
                comments: 3,
                lastUpdateISO: "2025-08-26T12:30:00Z",
              },
            ],
          },
          {
            id: "f-02",
            name: "منتصف الحلقة – الأكشن",
            order: 2,
            scenes: [
              {
                id: "s-03",
                title: "المشهد 03 – التحوّل",
                thumbnail:
                  "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=800&auto=format&fit=crop",
                status: "changes",
                shots: 16,
                comments: 2,
                lastUpdateISO: "2025-08-25T15:15:00Z",
              },
            ],
          },
        ]);

        const [activeFolderId, setActiveFolderId] = useState(null);
        const [activeSceneId, setActiveSceneId] = useState(null);

        // ---- Navigation helpers
        function openFolder(fid) {
          setActiveFolderId(fid);
          setPage("folder");
        }
        function openScene(fid, sid) {
          setActiveFolderId(fid);
          setActiveSceneId(sid);
          setPage("review");
        }

        // ---- Folder CRUD (lightweight, in-memory)
        function createFolder() {
          const name = prompt("اسم المجلد الجديد؟");
          if (!name) return;
          setFolders((prev) => {
            const maxOrder = Math.max(0, ...prev.map((f) => f.order));
            return [
              ...prev,
              { id: Math.random().toString(36).slice(2), name, order: maxOrder + 1, scenes: [] },
            ];
          });
        }
        function renameFolder(fid) {
          const curr = folders.find((f) => f.id === fid);
          const name = prompt("إعادة تسمية المجلد إلى:", curr ? curr.name : "");
          if (!name) return;
          setFolders((prev) => prev.map((f) => (f.id === fid ? { ...f, name } : f)));
        }
        function reorderFolder(fid, dir) {
          setFolders((prev) => {
            const sorted = [...prev].sort((a, b) => a.order - b.order);
            const idx = sorted.findIndex((f) => f.id === fid);
            if (idx < 0) return prev;
            const swapIdx = idx + dir;
            if (swapIdx < 0 || swapIdx >= sorted.length) return prev;
            const a = sorted[idx];
            const b = sorted[swapIdx];
            const tmp = a.order;
            a.order = b.order;
            b.order = tmp;
            return [...sorted];
          });
        }

        // ---- Scene reorder inside a folder
        function moveScene(fid, sid, dir) {
          setFolders((prev) =>
            prev.map((f) => {
              if (f.id !== fid) return f;
              const scenes = [...f.scenes];
              const idx = scenes.findIndex((s) => s.id === sid);
              const swap = idx + dir;
              if (idx < 0 || swap < 0 || swap >= scenes.length) return f;
              const tmp = scenes[idx];
              scenes[idx] = scenes[swap];
              scenes[swap] = tmp;
              return { ...f, scenes };
            })
          );
        }

        return (
          <div dir="rtl" className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900">
            <header className="sticky top-0 z-30 border-b bg-white/80 backdrop-blur">
              <div className="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <div className="size-10 rounded-2xl bg-indigo-600/10 ring-1 ring-indigo-600/20 grid place-items-center">
                    <span className="text-indigo-600 font-black">AN</span>
                  </div>
                  <div>
                    <h1 className="text-lg md:text-xl font-bold">
                      {page === "library" && "مكتبة المشاهد – تنظيم بالمجلدات"}
                      {page === "folder" && `مجلد: ${(folders.find((f) => f.id === activeFolderId) || {}).name || "—"}`}
                      {page === "review" && "لوحة مراجعة الرسم"}
                    </h1>
                    <p className="text-sm text-slate-500">
                      {page === "library" && "أنشئ مجلدات، رتّبها، واعرض المشاهد Grid/List"}
                      {page === "folder" && "اختر مشهدًا لفتح لوحة المراجعة أو أعد ترتيب المشاهد"}
                      {page === "review" && "تعليقات مثبّتة، حالات إصدار، ومعاينة تفاعلية"}
                    </p>
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  {page !== "library" && (
                    <button className="rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50" onClick={() => setPage("library")}>
                      ← رجوع للمكتبة
                    </button>
                  )}
                  {page === "library" && (
                    <>
                      <button className="rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50" onClick={() => setViewMode("grid")}>شبكة</button>
                      <button className="rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50" onClick={() => setViewMode("list")}>قائمة</button>
                      <button className="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm shadow-sm hover:bg-indigo-700" onClick={createFolder}>+ مجلد جديد</button>
                    </>
                  )}
                </div>
              </div>
            </header>

            <main className="mx-auto max-w-7xl px-4 py-6">
              {page === "library" && (
                <LibraryPage
                  folders={[...folders].sort((a, b) => a.order - b.order)}
                  viewMode={viewMode}
                  onOpenFolder={openFolder}
                  onRenameFolder={renameFolder}
                  onReorderFolder={reorderFolder}
                />
              )}

              {page === "folder" && activeFolderId && (
                <FolderPage
                  folder={folders.find((f) => f.id === activeFolderId)}
                  viewMode={viewMode}
                  onBack={() => setPage("library")}
                  onOpenScene={(sid) => openScene(activeFolderId, sid)}
                  onMoveScene={(sid, dir) => moveScene(activeFolderId, sid, dir)}
                />
              )}

              {page === "review" && activeFolderId && activeSceneId && (
                <ReviewPage
                  folderName={(folders.find((f) => f.id === activeFolderId) || {}).name || "—"}
                  scene={folders.find((f) => f.id === activeFolderId).scenes.find((s) => s.id === activeSceneId)}
                  onBack={() => setPage("folder")}
                />
              )}
            </main>
          </div>
        );
      }

      // =================================
      //            LIBRARY PAGE
      // =================================
      function LibraryPage({ folders, viewMode, onOpenFolder, onRenameFolder, onReorderFolder }) {
        if (!folders || folders.length === 0) {
          return (
            <div className="rounded-2xl border bg-white p-8 text-center text-slate-500">لا توجد مجلدات بعد.</div>
          );
        }

        if (viewMode === "list") {
          return (
            <div className="rounded-2xl border bg-white p-2 overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-slate-50 text-slate-600">
                  <tr>
                    <th className="px-3 py-2 text-right">المجلد</th>
                    <th className="px-3 py-2 text-right">عدد المشاهد</th>
                    <th className="px-3 py-2 text-right">آخر تحديث</th>
                    <th className="px-3 py-2"></th>
                  </tr>
                </thead>
                <tbody>
                  {folders.map((f) => {
                    const last = f.scenes.map((s) => s.lastUpdateISO).sort().pop();
                    return (
                      <tr key={f.id} className="border-t">
                        <td className="px-3 py-3">
                          <div className="font-semibold">{f.name}</div>
                        </td>
                        <td className="px-3 py-3">{f.scenes.length}</td>
                        <td className="px-3 py-3 text-slate-500">{last ? new Date(last).toLocaleString("ar-EG") : "—"}</td>
                        <td className="px-3 py-3 text-left">
                          <div className="flex items-center gap-2 justify-end">
                            <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => onRenameFolder(f.id)}>إعادة تسمية</button>
                            <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => onReorderFolder(f.id, -1)}>⬆️ أعلى</button>
                            <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => onReorderFolder(f.id, 1)}>⬇️ أسفل</button>
                            <button className="rounded-lg bg-indigo-600 text-white px-3 py-1 hover:bg-indigo-700" onClick={() => onOpenFolder(f.id)}>فتح</button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          );
        }

        // Grid
        return (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {folders.map((f) => {
              const last = f.scenes.map((s) => s.lastUpdateISO).sort().pop();
              const preview = (f.scenes[0] || {}).thumbnail;
              return (
                <div key={f.id} className="rounded-2xl border bg-white overflow-hidden shadow-sm">
                  <div className="aspect-video bg-slate-100">
                    {preview ? (
                      <img src={preview} className="h-full w-full object-cover" />
                    ) : (
                      <div className="h-full w-full grid place-items-center text-slate-400">بدون صورة</div>
                    )}
                  </div>
                  <div className="p-4 space-y-2">
                    <div className="flex items-center justify-between gap-2">
                      <h3 className="font-semibold truncate" title={f.name}>{f.name}</h3>
                      <span className="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600">{f.scenes.length} مشاهد</span>
                    </div>
                    <div className="text-xs text-slate-500">آخر تحديث: {last ? new Date(last).toLocaleDateString("ar-EG") : "—"}</div>
                    <div className="flex items-center gap-2">
                      <button className="rounded-lg border px-2 py-1 text-sm hover:bg-slate-50" onClick={() => onRenameFolder(f.id)}>إعادة تسمية</button>
                      <button className="rounded-lg border px-2 py-1 text-sm hover:bg-slate-50" onClick={() => onReorderFolder(f.id, -1)}>⬆️</button>
                      <button className="rounded-lg border px-2 py-1 text-sm hover:bg-slate-50" onClick={() => onReorderFolder(f.id, 1)}>⬇️</button>
                      <button className="ml-auto rounded-lg bg-indigo-600 text-white px-3 py-1.5 text-sm hover:bg-indigo-700" onClick={() => onOpenFolder(f.id)}>فتح المجلد</button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      // =================================
      //            FOLDER PAGE
      // =================================
      function FolderPage({ folder, viewMode, onBack, onOpenScene, onMoveScene }) {
        if (!folder || !folder.scenes || folder.scenes.length === 0) {
          return (
            <div className="rounded-2xl border bg-white p-8 text-center text-slate-500">لا توجد مشاهد في هذا المجلد.</div>
          );
        }

        if (viewMode === "list") {
          return (
            <div className="rounded-2xl border bg-white p-2 overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-slate-50 text-slate-600">
                  <tr>
                    <th className="px-3 py-2 text-right">المشهد</th>
                    <th className="px-3 py-2 text-right">الحالة</th>
                    <th className="px-3 py-2 text-right">اللقطات</th>
                    <th className="px-3 py-2 text-right">تعليقات مفتوحة</th>
                    <th className="px-3 py-2 text-right">آخر تحديث</th>
                    <th className="px-3 py-2"></th>
                  </tr>
                </thead>
                <tbody>
                  {folder.scenes.map((s, idx) => (
                    <tr key={s.id} className="border-t">
                      <td className="px-3 py-3">
                        <div className="flex items-center gap-3">
                          <img src={s.thumbnail} className="size-12 rounded-md object-cover" />
                          <div className="font-semibold">{s.title}</div>
                        </div>
                      </td>
                      <td className="px-3 py-3"><StatusPill status={s.status} /></td>
                      <td className="px-3 py-3">{s.shots ?? "—"}</td>
                      <td className="px-3 py-3">{s.comments ?? 0}</td>
                      <td className="px-3 py-3 text-slate-500">{new Date(s.lastUpdateISO).toLocaleString("ar-EG")}</td>
                      <td className="px-3 py-3 text-left">
                        <div className="flex items-center gap-2 justify-end">
                          <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => onMoveScene(s.id, -1)} disabled={idx === 0}>⬆️ أعلى</button>
                          <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => onMoveScene(s.id, 1)} disabled={idx === folder.scenes.length - 1}>⬇️ أسفل</button>
                          <button className="rounded-lg bg-indigo-600 text-white px-3 py-1 hover:bg-indigo-700" onClick={() => onOpenScene(s.id)}>فتح</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        }

        // Grid
        return (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {folder.scenes.map((s, idx) => (
              <div key={s.id} className="rounded-2xl border bg-white overflow-hidden shadow-sm">
                <div className="aspect-video bg-slate-100 relative">
                  <img src={s.thumbnail} className="h-full w-full object-cover" />
                  {typeof s.comments === "number" && s.comments > 0 && (
                    <span className="absolute right-2 top-2 rounded-full bg-rose-600/90 px-2 py-0.5 text-xs text-white">{s.comments} تعليقات</span>
                  )}
                </div>
                <div className="p-4 space-y-2">
                  <div className="flex items-center justify-between gap-2">
                    <h3 className="font-semibold truncate" title={s.title}>{s.title}</h3>
                    <StatusPill status={s.status} />
                  </div>
                  <div className="text-xs text-slate-500 flex items-center gap-3">
                    <span>لقطات: {s.shots ?? "—"}</span>
                    <span>آخر تحديث: {new Date(s.lastUpdateISO).toLocaleDateString("ar-EG")}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <button className="rounded-lg border px-2 py-1 text-sm hover:bg-slate-50" onClick={() => onMoveScene(s.id, -1)} disabled={idx === 0}>⬆️</button>
                    <button className="rounded-lg border px-2 py-1 text-sm hover:bg-slate-50" onClick={() => onMoveScene(s.id, 1)} disabled={idx === folder.scenes.length - 1}>⬇️</button>
                    <button className="ml-auto rounded-lg bg-indigo-600 text-white px-3 py-1.5 text-sm hover:bg-indigo-700" onClick={() => onOpenScene(s.id)}>فتح المشهد</button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        );
      }

      // =================================
      //            REVIEW PAGE
      // =================================
      function ReviewPage({ folderName, scene, onBack }) {
        // Simplified versions per scene (mock)
        const [versions, setVersions] = useState([
          { id: "v3", name: "إصدار V3", createdAt: "2025-08-25T13:00:00Z", thumbnail: scene.thumbnail, status: scene.status, notes: "تفاصيل إضاءة محسّنة" },
          { id: "v2", name: "إصدار V2", createdAt: "2025-08-20T13:00:00Z", thumbnail: scene.thumbnail, status: "changes" },
          { id: "v1", name: "إصدار V1", createdAt: "2025-08-15T13:00:00Z", thumbnail: scene.thumbnail, status: "draft" },
        ]);
        const [activeVersionId, setActiveVersionId] = useState("v3");
        const activeVersion = useMemo(() => versions.find((v) => v.id === activeVersionId), [versions, activeVersionId]);

        // Comments (pins)
        const [comments, setComments] = useState([
          { id: "c1", author: "العميل – علي", role: "Client", at: "2025-08-26T10:20:00Z", text: "خفّف وهج النيون.", status: "open", pin: { xPct: 70, yPct: 42 } },
        ]);
        const [filter, setFilter] = useState("all"); // "all" | "open" | "resolved"
        const filtered = comments.filter((c) => (filter === "all" ? true : c.status === filter));
        const [newComment, setNewComment] = useState("");

        // Viewer basics
        const [zoom, setZoom] = useState(1);
        const [isPanning, setIsPanning] = useState(false);
        const [offset, setOffset] = useState({ x: 0, y: 0 });
        const lastPoint = useRef(null);
        const viewerRef = useRef(null);

        function onWheel(e) {
          e.preventDefault();
          const delta = e.deltaY > 0 ? -0.1 : 0.1;
          setZoom((z) => Math.min(3, Math.max(0.5, parseFloat((z + delta).toFixed(2)))));
        }
        function onMouseDown(e) {
          setIsPanning(true);
          lastPoint.current = { x: e.clientX, y: e.clientY };
        }
        function onMouseMove(e) {
          if (!isPanning || !lastPoint.current) return;
          const dx = e.clientX - lastPoint.current.x;
          const dy = e.clientY - lastPoint.current.y;
          setOffset((o) => ({ x: o.x + dx, y: o.y + dy }));
          lastPoint.current = { x: e.clientX, y: e.clientY };
        }
        function onMouseUp() {
          setIsPanning(false);
          lastPoint.current = null;
        }
        function onViewerClick(e) {
          if (!viewerRef.current) return;
          if (!newComment.trim()) return; // only drop pin if text exists
          const rect = viewerRef.current.getBoundingClientRect();
          const xPct = ((e.clientX - rect.left) / rect.width) * 100;
          const yPct = ((e.clientY - rect.top) / rect.height) * 100;
          addComment({ xPct, yPct });
        }

        function setVersionStatus(id, status) {
          setVersions((prev) => prev.map((v) => (v.id === id ? { ...v, status } : v)));
        }

        function addComment(pin) {
          if (!newComment.trim()) return;
          const c = { id: Math.random().toString(36).slice(2), author: "أنت", role: "Reviewer", at: new Date().toISOString(), text: newComment.trim(), status: "open", pin };
          setComments((prev) => [c, ...prev]);
          setNewComment("");
        }

        return (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
            {/* Left */}
            <section className="lg:col-span-8 space-y-4">
              <div className="rounded-2xl border bg-white p-4 shadow-sm flex items-center justify-between gap-3">
                <div>
                  <div className="text-sm text-slate-500">المجلد</div>
                  <div className="font-semibold">{folderName}</div>
                  <div className="text-xs text-slate-500 mt-1">المشهد: {scene.title}</div>
                </div>
                <div className="flex items-center gap-2">
                  <StatusPill status={activeVersion.status} />
                  <button className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-50" onClick={() => setVersionStatus(activeVersion.id, "review")}>قيد المراجعة</button>
                  <button className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-50" onClick={() => setVersionStatus(activeVersion.id, "changes")}>طلب تعديلات</button>
                  <button className="rounded-xl bg-emerald-600 text-white px-3 py-1.5 text-sm hover:bg-emerald-700" onClick={() => setVersionStatus(activeVersion.id, "approved")}>اعتماد</button>
                  <button className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-50" onClick={onBack}>← رجوع للمجلد</button>
                </div>
              </div>

              <div className="rounded-2xl border bg-white p-3 shadow-sm">
                <div className="flex items-center justify-between px-2 pb-2">
                  <div className="text-sm text-slate-600">اكتب تعليقًا ثم انقر على الصورة لتثبيت دبوس.</div>
                  <div className="flex items-center gap-2 text-sm">
                    <button className="rounded-xl border px-2 py-1 hover:bg-slate-50" onClick={() => setZoom((z) => Math.max(0.5, parseFloat((z - 0.1).toFixed(2))))}>–</button>
                    <span className="w-16 text-center tabular-nums">{Math.round(zoom * 100)}%</span>
                    <button className="rounded-xl border px-2 py-1 hover:bg-slate-50" onClick={() => setZoom((z) => Math.min(3, parseFloat((z + 0.1).toFixed(2))))}>+</button>
                    <button className="rounded-xl border px-2 py-1 hover:bg-slate-50" onClick={() => { setZoom(1); setOffset({ x: 0, y: 0 }); }}>إعادة الضبط</button>
                  </div>
                </div>
                <div
                  ref={viewerRef}
                  onWheel={onWheel}
                  onMouseDown={onMouseDown}
                  onMouseMove={onMouseMove}
                  onMouseUp={onMouseUp}
                  onMouseLeave={onMouseUp}
                  onClick={onViewerClick}
                  className="relative aspect-video w-full overflow-hidden rounded-xl border bg-slate-100"
                >
                  <img
                    src={activeVersion.thumbnail}
                    alt={activeVersion.name}
                    className="pointer-events-none select-none"
                    style={{ transform: `translate(${offset.x}px, ${offset.y}px) scale(${zoom})`, transformOrigin: "center center", width: "100%", height: "100%", objectFit: "cover" }}
                  />
                  {filtered.filter((c) => c.pin).map((c, i) => (
                    <div key={c.id} className={cx("absolute size-6 -translate-x-1/2 -translate-y-1/2 rounded-full ring-2 ring-white grid place-items-center font-bold", c.status === "open" ? "bg-rose-600 text-white" : "bg-emerald-600 text-white")} style={{ left: `${c.pin.xPct}%`, top: `${c.pin.yPct}%` }} title={`${i + 1}. ${c.text}`}>
                      {i + 1}
                    </div>
                  ))}
                </div>
              </div>

              <div className="rounded-2xl border bg-white p-4 shadow-sm">
                <div className="mb-3 flex items-center justify-between">
                  <h3 className="text-sm font-semibold">الإصدارات</h3>
                  <span className="text-xs text-slate-500">انقر للتبديل</span>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  {versions.map((v) => (
                    <button key={v.id} onClick={() => setActiveVersionId(v.id)} className={cx("group flex items-center gap-3 rounded-xl border p-2 text-start transition hover:shadow", v.id === activeVersionId ? "ring-2 ring-indigo-500" : "")} title={new Date(v.createdAt).toLocaleString("ar-EG")}>
                      <img src={v.thumbnail} className="size-14 rounded-lg object-cover" />
                      <div className="min-w-0">
                        <div className="flex items-center gap-2">
                          <span className="truncate font-medium">{v.name}</span>
                          <StatusPill status={v.status} />
                        </div>
                        <div className="text-xs text-slate-500 truncate">{new Date(v.createdAt).toLocaleDateString("ar-EG")}</div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            </section>

            {/* Right */}
            <aside className="lg:col-span-4 space-y-4">
              <div className="rounded-2xl border bg-white p-4 shadow-sm">
                <div className="mb-2 text-sm font-semibold">إضافة تعليق</div>
                <textarea className="w-full rounded-xl border p-3 text-sm shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="اكتب تعليقك هنا… ثم انقر على الصورة لتثبيت دبوس" value={newComment} onChange={(e) => setNewComment(e.target.value)} />
                <div className="mt-2 flex items-center justify-between text-sm">
                  <div className="flex items-center gap-2">
                    <span className="text-slate-500">تصفية:</span>
                    {[
                      { key: "all", label: "الكل" },
                      { key: "open", label: "مفتوح" },
                      { key: "resolved", label: "مغلق" },
                    ].map((f) => (
                      <button key={f.key} className={cx("rounded-full px-3 py-1", filter === f.key ? "bg-slate-900 text-white" : "bg-slate-100 hover:bg-slate-200")} onClick={() => setFilter(f.key)}>
                        {f.label}
                      </button>
                    ))}
                  </div>
                  <button className={cx("rounded-xl px-4 py-1.5 text-white", newComment.trim() ? "bg-indigo-600 hover:bg-indigo-700" : "bg-slate-300")} disabled={!newComment.trim()} onClick={() => addComment(undefined)}>
                    إضافة
                  </button>
                </div>
              </div>

              <div className="rounded-2xl border bg-white p-2 shadow-sm max-h-[58vh] overflow-auto">
                {filtered.length === 0 ? (
                  <div className="p-6 text-center text-slate-500 text-sm">لا توجد تعليقات.</div>
                ) : (
                  <ul className="space-y-2">
                    {filtered.map((c, i) => (
                      <li key={c.id} className="rounded-xl border p-3">
                        <div className="mb-1 flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className={cx("size-6 grid place-items-center rounded-full text-xs font-bold text-white", c.status === "open" ? "bg-rose-600" : "bg-emerald-600")}>{i + 1}</span>
                            <span className="text-sm font-semibold">{c.author}</span>
                            {c.role && <span className="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600">{c.role}</span>}
                          </div>
                          <time className="text-xs text-slate-500">{new Date(c.at).toLocaleString("ar-EG")}</time>
                        </div>
                        <p className="text-sm leading-6 whitespace-pre-wrap">{c.text}</p>
                        <div className="mt-2 flex items-center justify-between text-xs text-slate-500">
                          {c.pin ? <span>مثبّت على الصورة</span> : <span>بدون تثبيت</span>}
                          <div className="flex items-center gap-2">
                            {c.status === "open" ? (
                              <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => setComments((prev) => prev.map((x) => (x.id === c.id ? { ...x, status: "resolved" } : x)))}>وضع علامة كمغلق</button>
                            ) : (
                              <button className="rounded-lg border px-2 py-1 hover:bg-slate-50" onClick={() => setComments((prev) => prev.map((x) => (x.id === c.id ? { ...x, status: "open" } : x)))}>إعادة فتح</button>
                            )}
                            <button className="rounded-lg border px-2 py-1 hover:bg-red-50 hover:text-red-600" onClick={() => setComments((prev) => prev.filter((x) => x.id !== c.id))}>حذف</button>
                          </div>
                        </div>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </aside>
          </div>
        );
      }

      // =================================
      //          Shared UI bits
      // =================================
      function StatusPill({ status }) {
        const map = {
          draft: { label: "مسودة", cls: "bg-slate-200 text-slate-800" },
          review: { label: "قيد المراجعة", cls: "bg-amber-100 text-amber-700" },
          changes: { label: "طلب تعديلات", cls: "bg-rose-100 text-rose-700" },
          approved: { label: "معتمد", cls: "bg-emerald-100 text-emerald-700" },
        };
        const item = map[status] || map.draft;
        return <span className={cx("inline-flex items-center rounded-full px-3 py-1 text-xs font-medium", item.cls)}>{item.label}</span>;
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<AnimationWorkspace />);
    </script>
  </body>
</html>
